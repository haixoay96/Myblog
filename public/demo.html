<!DOCTYPE html>
<html lang="en" xmlns:sau="http://www.w3.org/1999/xhtml">
<head>
    <title>Blog developer !</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/node_modules/bootstrap/dist/css/bootstrap.min.css">
    <link href="http://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
    <link rel="shortcut icon" type="image/PNG" href="/public/images/icon.png"/>
    <script src="/node_modules/jquery/dist/jquery.min.js"></script>
    <script src="/node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
    <style>
        body {
            font: 20px Montserrat, sans-serif;
            line-height: 1.8;
            color: #f5f6f7;
        }

        p {
            font-size: 16px;
        }

        .margin {
            margin-bottom: 45px;
        }

        .bg-1 {
            background-color: #1abc9c; /* Green */
            color: #ffffff;
        }

        .bg-2 {
            background-color: #474e5d; /* Dark Blue */
            color: #ffffff;
        }

        .bg-3 {
            background-color: #ffffff; /* White */
            color: #555555;
        }

        .bg-4 {
            background-color: #2f2f2f; /* Black Gray */
            color: #fff;
        }

        .container-fluid {
            padding-top: 70px;
            padding-bottom: 70px;
        }

        .navbar {
            padding-top: 15px;
            padding-bottom: 15px;
            border: 0;
            border-radius: 0;
            margin-bottom: 0;
            font-size: 12px;
            letter-spacing: 5px;
        }

        .navbar-nav li a:hover {
            color: #1abc9c !important;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-default">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Home</a>
        </div>
        <div class="collapse navbar-collapse" id="myNavbar">
            <ul class="nav navbar-nav navbar-right">
                <li><a href="#">Who?</a></li>
                <li><a href="#">What?</a></li>
                <li><a href="#">How?</a></li>
                <li><a href="#">Book</a></li>
                <li class="dropdown">
                    <a class="dropdown-toggle" data-toggle="dropdown">Programming<span class="caret"></span></a>
                    <ul class="dropdown-menu">
                        <li><a href="/programming/1">Java</a></li>
                        <li><a href="/programming/2">Android</a></li>
                        <li><a href="/programming/3">Nodejs</a></li>
                        <li><a href="/programming/4">C/C++</a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>
<div class="container">
    <div class="jumbotron">
        <p style="color: #2f2f2f">
            Chào các bạn hôm nay mình sẽ giải thích cho các bạn về cơ chế Nonblocking, Event loop và Queue event trong nodejs. <br>
            Đầu tiên chúng ta cần phải biết là nodejs chạy single thread ( đơn luồng ) tức là chỉ có một luồng duy nhất, mọi đoạn mã code chỉ được thực thi bởi một luồng <br>
            Chúng ta cùng xem đoạn code sau:
        </p>
        <pre style='color:#d1d1d1;background:#000000;'>console<span style='color:#d2cd86; '>.</span><span style='color:#e66170; font-weight:bold; '>log</span><span style='color:#d2cd86; '>(</span><span style='color:#02d045; '>'</span><span style='color:#00c4c4; '>hello world</span><span style='color:#02d045; '>'</span><span style='color:#d2cd86; '>)</span><span style='color:#b060b0; '>;</span>
console<span style='color:#d2cd86; '>.</span><span style='color:#e66170; font-weight:bold; '>log</span><span style='color:#d2cd86; '>(</span><span style='color:#02d045; '>'</span><span style='color:#00c4c4; '>next</span><span style='color:#02d045; '>'</span><span style='color:#d2cd86; '>)</span><span style='color:#b060b0; '>;</span>
<span style='color:#9999a9; '>// nó sẽ in ra</span>
hello world
next
</pre>
        <p style="color: #2f2f2f">
            Đoạn code trên được thực thi từ trên xuống dưới ( hihi ai cũng biết ).<br>
            Giờ chúng ta xem đoạn code sau:<br>
        </p>
        <pre style='color:#d1d1d1;background:#000000;'><span style='color:#e66170; font-weight:bold; '>var</span> fs <span style='color:#d2cd86; '>=</span> require<span style='color:#d2cd86; '>(</span><span style='color:#02d045; '>'</span><span style='color:#00c4c4; '>fs</span><span style='color:#02d045; '>'</span><span style='color:#d2cd86; '>)</span><span style='color:#b060b0; '>;</span>
fs<span style='color:#d2cd86; '>.</span>readFile<span style='color:#d2cd86; '>(</span><span style='color:#02d045; '>'</span><span style='color:#00c4c4; '>data.txt</span><span style='color:#02d045; '>'</span><span style='color:#d2cd86; '>,</span> <span style='color:#e66170; font-weight:bold; '>function</span> <span style='color:#d2cd86; '>(</span>err<span style='color:#d2cd86; '>,</span> data<span style='color:#d2cd86; '>)</span> <span style='color:#b060b0; '>{</span>
  console<span style='color:#d2cd86; '>.</span><span style='color:#e66170; font-weight:bold; '>log</span><span style='color:#d2cd86; '>(</span>data<span style='color:#d2cd86; '>)</span><span style='color:#b060b0; '>;</span>
<span style='color:#b060b0; '>}</span><span style='color:#d2cd86; '>)</span><span style='color:#b060b0; '>;</span>
console<span style='color:#d2cd86; '>.</span><span style='color:#e66170; font-weight:bold; '>log</span><span style='color:#d2cd86; '>(</span><span style='color:#02d045; '>'</span><span style='color:#00c4c4; '>first</span><span style='color:#02d045; '>'</span><span style='color:#d2cd86; '>)</span><span style='color:#b060b0; '>;</span>
<span style='color:#9999a9; '>// nó sẽ in ra là </span>
fisrt
hello world
</pre>
        <p style="color: #2f2f2f">
            Giả sử là mình có file data.txt trong cùng thư mục với file code nhé và trong file data.txt chứa nội dung là hello world.<br>
            Chúng ta thấy là theo logic thì nó phải in ra:<br>
            hello world<br>
            first<br>
            Đúng không ? Nhưng nó lại in ra:<br>
            first<br>
            hello world<br>
            Đấy Nonblocking bắt đầu xuất hiện ở đây, cụ thể là cái hàm fs.readFile là một hàm được thiết kế theo cơ chế nonblocking. Chúng ta có thể hiểu là hàm fs.readFile sẽ ra lệch cho máy tính là đọc file data.txt đi, khi nào đọc xong thì báo cho tao , giờ tao phải đi làm việc khác đã :))<br>
            Và trong khi hàm fs.readFile nó đọc chuỗi hello world trong file thì chương trình tiếp tục in ra chữ first cho đến khi fs.readFile đọc xong thì nó sẽ in ra chuỗi hello world.<br>
            Chúng ta có thể thấy cái hàm mà chúng ta truyền vào hàm fs.readFile chính là hàm callback mà hôm trước chúng ta đã bàn luận.<br>
            Ơ thế nó dễ như vậy thôi à ? .......<br>
            Nhưng từ từ đã có một CHÚ Ý !!! cực kỳ quan trọng ở đây là, cái việc khác mà chúng ta làm ấy , các việc mà chúng ta làm trong khi hàm fs.readFile đọc xong file data.txt. Nếu như công việc đó chưa hoàn thành thì file sẽ chẳng bao giờ được đọc . Tức là các công việc in chữ first phải xong rồi thì nó mới bắt đầu đọc file rồi in ra  hello world.<br>
            Tại sao lại như vậy nhỉ ? Tại vì nodejs là single thread  tức nó vẫn sẽ thực hiện tuần tự lần lượt từng lệch, không thể 1 lúc thực thi 2 lệch như đa luồng được :(( <br>
            Đến đây dẫn đến khái niệm Event loop ( vòng lặp sự kiên ) và Queue event ( hàng đợi sự kiên).<br>
            Chúng ta cần phải phân tích lại cơ chế hoạt động của đoạn code trên như sau. <br>
            Cái hàm callback mà chúng ta truyền vào hàm fs.readFile để in ra chữ hello world khi hàm fs.readFile đọc xong file, sẽ được Event loop liên tục kiểm tra xem khi nào hàm fs.readFile đọc xong file, khi đọc xong thì nó sẽ thông báo cho Queue event để đưa hàm callback đó vào Queue event , được đưa vào Queue event chứ không phải được thực thi nhé! <br>
            Và trong Queue event khi nào câu lệch đứng trước hàm callback được thực hiện thì nó mới được thực hiện.<br>
            Chạy file chương trình -->thông báo khi nào cho Event loop khi nào file đọc xong thì cho callback vào Queue event--> in ra first -- >đọc file --> đọc xong cho callback vào Queue event --> in thông tin file.<br>
            Chúng ta tham khảo đoạn code dưới đây để có thể hiểu hơn về Nonblocking , Event loop , Queue event.<br>
        </p>
        <pre style='color:#d1d1d1;background:#000000;'><span style='color:#e66170; font-weight:bold; '>var</span> fs <span style='color:#d2cd86; '>=</span> require<span style='color:#d2cd86; '>(</span><span style='color:#02d045; '>'</span><span style='color:#00c4c4; '>fs</span><span style='color:#02d045; '>'</span><span style='color:#d2cd86; '>)</span><span style='color:#b060b0; '>;</span>
fs<span style='color:#d2cd86; '>.</span>readFile<span style='color:#d2cd86; '>(</span><span style='color:#02d045; '>'</span><span style='color:#00c4c4; '>data.txt</span><span style='color:#02d045; '>'</span><span style='color:#d2cd86; '>,</span> <span style='color:#e66170; font-weight:bold; '>function</span> <span style='color:#d2cd86; '>(</span>err<span style='color:#d2cd86; '>,</span> data<span style='color:#d2cd86; '>)</span> <span style='color:#b060b0; '>{</span>
  console<span style='color:#d2cd86; '>.</span><span style='color:#e66170; font-weight:bold; '>log</span><span style='color:#d2cd86; '>(</span>data<span style='color:#d2cd86; '>)</span><span style='color:#b060b0; '>;</span>
<span style='color:#b060b0; '>}</span><span style='color:#d2cd86; '>)</span><span style='color:#b060b0; '>;</span>
<span style='color:#e66170; font-weight:bold; '>while</span><span style='color:#d2cd86; '>(</span><span style='color:#0f4d75; '>true</span><span style='color:#d2cd86; '>)</span><span style='color:#b060b0; '>{</span>

<span style='color:#b060b0; '>}</span>
<span style='color:#9999a9; '>// đoạn code trên vĩnh viễn không bao giờ in ra được chữ hello world vì trong Queue event vòng lặp while chưa được thực hiện xong</span>
</pre>
        <p style="color:#2f2f2f;">
            Hay đoạn code này !
        </p>
        <pre style='color:#d1d1d1;background:#000000;'><span style='color:#9999a9; '>// utility funcion</span>
<span style='color:#e66170; font-weight:bold; '>function</span> fibonacci<span style='color:#d2cd86; '>(</span>n<span style='color:#d2cd86; '>)</span> <span style='color:#b060b0; '>{</span>
<span style='color:#e66170; font-weight:bold; '>if</span> <span style='color:#d2cd86; '>(</span>n <span style='color:#d2cd86; '>&lt;</span> <span style='color:#008c00; '>2</span><span style='color:#d2cd86; '>)</span>
<span style='color:#e66170; font-weight:bold; '>return</span> <span style='color:#008c00; '>1</span><span style='color:#b060b0; '>;</span>
<span style='color:#e66170; font-weight:bold; '>else</span>
<span style='color:#e66170; font-weight:bold; '>return</span> fibonacci<span style='color:#d2cd86; '>(</span>n <span style='color:#d2cd86; '>-</span> <span style='color:#008c00; '>2</span><span style='color:#d2cd86; '>)</span> <span style='color:#d2cd86; '>+</span> fibonacci<span style='color:#d2cd86; '>(</span>n <span style='color:#d2cd86; '>-</span> <span style='color:#008c00; '>1</span><span style='color:#d2cd86; '>)</span><span style='color:#b060b0; '>;</span>
<span style='color:#b060b0; '>}</span>
<span style='color:#9999a9; '>// đánh dấu thời gian bắt đầu</span>
console<span style='color:#d2cd86; '>.</span>time<span style='color:#d2cd86; '>(</span><span style='color:#02d045; '>'</span><span style='color:#00c4c4; '>timer</span><span style='color:#02d045; '>'</span><span style='color:#d2cd86; '>)</span><span style='color:#b060b0; '>;</span>
<span style='color:#e66170; font-weight:bold; '>setTimeout</span><span style='color:#d2cd86; '>(</span><span style='color:#e66170; font-weight:bold; '>function</span> <span style='color:#d2cd86; '>(</span><span style='color:#d2cd86; '>)</span> <span style='color:#b060b0; '>{</span>
console<span style='color:#d2cd86; '>.</span>timeEnd<span style='color:#d2cd86; '>(</span><span style='color:#02d045; '>'</span><span style='color:#00c4c4; '>timer</span><span style='color:#02d045; '>'</span><span style='color:#d2cd86; '>)</span><span style='color:#b060b0; '>;</span> <span style='color:#9999a9; '>//in ra thời gian khi nó được gọi</span>
<span style='color:#b060b0; '>}</span><span style='color:#d2cd86; '>,</span> <span style='color:#008c00; '>1000</span><span style='color:#d2cd86; '>)</span>
fibonacci<span style='color:#d2cd86; '>(</span><span style='color:#008c00; '>44</span><span style='color:#d2cd86; '>)</span><span style='color:#b060b0; '>;</span>
</pre>
        <p style="color: #2f2f2f">
            Hàm callback trong hàm setTimeout sẽ được đưa vào event loop sau 1 giây. <br>
            Khi bạn chạy đoạn code trên chúng ta thấy ra nó sẽ in ra kết quả lớn hơn 1 giây<br>
            Tại vì sau 1 giây nó mới chỉ được đưa vào event loop thôi chứ chưa được thực thi , nó phải đợi khi nào hàm fibonacci thực thi xong đã bởi hàm fibonacci được đưa vào Queue event trước ! <br>
            Hàm fibonacci được đưa vào Queue event ngay sau khi hàm setTimeout được thực thi còn hàm callback thì sau một giây sau mới được đưa vào Queue event.<br>
            Còn cơ chế hoạt động của hàng đợi thì chắc ai cũng biết rồi nhỉ ? , first in first out. <br>
            Hi vọng bài viết có thể giúp bạn hiểu thêm về nodejs.<br>
            Cảm ơn các bạn đã theo dõi bài viết !
        </p>
    </div>
</div>

</body>
</html>